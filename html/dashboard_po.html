<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Tableau de bord - Tr√©sorerie</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF pour export PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- SheetJS pour export XLS (simple) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        :root{--bg:#f5f7fb;--card:#fff;--accent:#1f8a70;--danger:#d9534f;}
        body {font-family: 'Poppins', sans-serif; background: linear-gradient(90deg, #ffffff, #ffffff); color: #222; margin: 0; padding: 0;}
        header {background: linear-gradient(90deg, #b46ff1, #ff4ca8); color: white; display: flex; justify-content: space-between; align-items: center; padding: 10px 25px;}
        header .logo img{height:36px;}
        nav a{margin-right:16px;text-decoration:none;color:#333}
        main{padding:20px;max-width:1200px;margin:18px auto;}
        .infos{display:grid;grid-template-columns:1fr 1fr 2fr;gap:16px;margin-bottom:18px;}
        .client-card,.solde-card,.chart-card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
        .client-card p{margin:0}
        .solde-card .solde{margin:6px 0;font-size:28px;}
        .controls{display:flex;gap:8px;align-items:center;margin-bottom:8px}
        .transactions{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
        table {width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}        
        th, td {padding: 12px 16px; text-align: left; border-bottom: 1px solid #ddd;}
        th {background: #f4f2f9; color: #444; font-weight: 600; cursor: pointer;}
        th .arrow{margin-left:6px}
        tr.detail-row{display:none;background:#fbfbfb}
        .row-toggle{cursor:pointer}
        .negatif{color:var(--danger)}
        .positif{color:green}
        .totals{font-weight:700;padding:10px 0;text-align:right}
        .pager{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:10px}
        .pagination{display:flex;gap:6px}
        .btn{padding:8px 10px;border-radius:6px;background:#f1f5f6;border:1px solid #e6eaec;cursor:pointer}
        .btn.primary{background:var(--accent);color:#fff;border:none}
        .badge{background:#eef7ef;color:#257a4b;padding:4px 8px;border-radius:6px;font-size:13px}
        .color-band-1{background:#f7fbff}
        .color-band-2{background:#fef7e6}
        .color-band-3{background:#fff2f2}
        .topbar-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .result-count{font-size:14px;margin-left:6px}
        .small{font-size:13px;color:#666}
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <img src="logo.png" alt="logo">
        </div>
        <nav>
            <a href="#">D√©connecter</a>
            <a href="#">√† propos</a>
            <div class="menu">‚ò∞</div>
        </nav>
    </header>

    <main>
        <section class="infos">
            <div class="client-card">
                <p><strong>Mr. Boukayouh Yanis</strong><br>PO</p>
                <p class="small">Portail de gestion de paiement - d√©monstration</p>
            </div>

            <div class="solde-card">
                <p>Solde Global :</p>
                <h1 id="solde-global" class="solde">+15 500$</h1>
                <p class="small" id="total-neg-display"></p>
            </div>

            <div class="chart-card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <div><strong>√âvolution de la tr√©sorerie</strong></div>
                    <div style="display:flex;gap:8px;align-items:center">
                        <label class="small">Type :</label>
                        <select id="chartTypeSelect" class="btn">
                            <option value="line">Courbe</option>
                            <option value="bar">Histogramme</option>
                        </select>
                    </div>
                </div>
                <canvas id="graphique" style="max-height:220px"></canvas>
            </div>
        </section>

        <section class="transactions">
            <div class="controls">
                <div class="topbar-actions">
                    <button class="btn" id="export-csv">Export CSV</button>
                    <button class="btn" id="export-xls">Export XLS</button>
                    <button class="btn" id="export-pdf">Export PDF</button>
                </div>

                <div style="margin-left:auto; display:flex; gap:8px; align-items:center">
                    <label for="search" class="small">Recherche :</label>
                    <input id="search" placeholder="Rechercher (SIREN, intitul√©, date, remise...)" />
                    <label class="small">Lignes :</label>
                    <select id="perPage" class="btn">
                        <option>5</option>
                        <option selected>10</option>
                        <option>25</option>
                        <option>50</option>
                    </select>
                </div>
            </div>

            <div style="display:flex;align-items:center;margin-bottom:8px">
                <div><strong id="result-count">10 r√©sultats</strong></div>
                <div class="result-count" id="total-remises"></div>
            </div>

            <table id="table-clients" aria-describedby="result-count">
                <thead>
                    <tr>
                        <th data-type="text">Identifiant : <span class="arrow">‚Üì</span></th>
                        <th data-type="text">Nom : <span class="arrow">‚Üì</span></th>
                        <th data-type="text">N¬∞ Siret : <span class="arrow">‚Üì</span></th>
                        <th data-type="number">Impay√©s : <span class="arrow">‚Üì</span></th>
                        <th>Acc√©der compte :</th>
                        <th>Voir plus :</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="data-row">
                        <td>US9652125</td>
                        <td>Yehven Kefa</td>
                        <td>784 671 695 00103</td>
                        <td class="negatif">-1000 $</td>
                        <td><button class="btn-acceder">‚öôÔ∏è Acc√©der</button></td>
                        <td><button class="btn-voir">üëÅÔ∏è Voir Plus</button></td>
                    </tr>

                    <tr class="data-row">
                        <td>US9652124</td>
                        <td>Thomas No√´l</td>
                        <td>784 671 678 04403</td>
                        <td class="negatif">-1500 $</td>
                        <td><button class="btn-acceder">‚öôÔ∏è Acc√©der</button></td>
                        <td><button class="btn-voir">üëÅÔ∏è Voir Plus</button></td>
                    </tr>

                    <tr class="data-row">
                        <td>US9652123</td>
                        <td>Yanis Boukayouh</td>
                        <td>784 671 695 00103</td>
                        <td class="negatif">-2000 $</td>
                        <td><button class="btn-acceder">‚öôÔ∏è Acc√©der</button></td>
                        <td><button class="btn-voir">üëÅÔ∏è Voir Plus</button></td>
                    </tr>

                    <tr class="data-row">
                        <td>US9652122</td>
                        <td>Rayan Essaidi</td>
                        <td>784 671 695 08423</td>
                        <td class="positif">0</td>
                        <td><button class="btn-acceder">‚öôÔ∏è Acc√©der</button></td>
                        <td><button class="btn-voir">üëÅÔ∏è Voir Plus</button></td>
                    </tr>

                    <tr class="data-row">
                        <td>US9652121</td>
                        <td>Hamza Revel</td>
                        <td>784 671 695 00103</td>
                        <td class="negatif">-2000 $</td>
                        <td><button class="btn-acceder">‚öôÔ∏è Acc√©der</button></td>
                        <td><button class="btn-voir">üëÅÔ∏è Voir Plus</button></td>
                    </tr>

                    <tr class="data-row">
                        <td>US9652120</td>
                        <td>John Pork</td>
                        <td>784 671 695 00104</td>
                        <td class="positif">0</td>
                        <td><button class="btn-acceder">‚öôÔ∏è Acc√©der</button></td>
                        <td><button class="btn-voir">üëÅÔ∏è Voir Plus</button></td>
                    </tr>
                </tbody>

                <tfoot>
                    <tr>
                        <td colspan="5" class="totals">Total (visible) : <span id="visible-total">0 $</span></td>
                    </tr>
                </tfoot>
            </table>

            <div class="pager">
                <div class="pagination" id="pagination"></div>
                <div>
                    <button class="btn" id="prevPage">Pr√©c</button>
                    <button class="btn" id="nextPage">Suiv</button>
                </div>
            </div>
        </section>
    </main>
    <script>
const table = document.getElementById('table-clients');
    const tbody = table.querySelector('tbody');
    const headers = table.querySelectorAll('th[data-type]');
    const perPageSelect = document.getElementById('perPage');
    const searchInput = document.getElementById('search');
    const resultCountEl = document.getElementById('result-count');
    const visibleTotalEl = document.getElementById('visible-total');
    const totalNegDisplay = document.getElementById('total-neg-display');
    const totalRemises = document.getElementById('total-remises');

    let rowsData = []; // tableau d'objets d√©riv√©s du DOM
    let filteredIndexList = []; // indices des rowsData affich√©s apr√®s filtre
    let currentPage = 1;

    // parse un montant (ex: "+1 000$" ou "-1000$")
    function parseAmount(text){
        if(!text) return 0;
        const cleaned = text.replace(/\s/g,'').replace('‚Ç¨','').replace('$','');
        const num = parseFloat(cleaned.replace('+','').replace('-','')) || 0;
        return text.includes('-') ? -Math.abs(num) : Math.abs(num);
    }

    // parse date format dd/mm/yy into Date object (ann√©e 2000+yy)
    function parseDateDMY(text){
        const parts = text.split('/');
        if(parts.length !== 3) return new Date(text);
        const d = parseInt(parts[0],10), m = parseInt(parts[1],10), yRaw = parseInt(parts[2],10);
        const y = yRaw < 100 ? 2000 + yRaw : yRaw;
        return new Date(y, m-1, d);
    }

    // initialiser rowsData depuis le DOM (assume chaque data-row suivi de detail-row)
    function initRows(){
        rowsData = [];
        const dataRows = Array.from(tbody.querySelectorAll('tr.data-row'));
        dataRows.forEach((r, idx) => {
            const cells = r.children;
            const date = cells[0].textContent.trim();
            const intitule = cells[1].textContent.trim();
            const siret = cells[2].textContent.trim();
            const montantText = cells[3].textContent.trim();
            const montant = parseAmount(montantText);
            const detailRow = r.nextElementSibling && r.nextElementSibling.classList.contains('detail-row') ? r.nextElementSibling : null;
            const detail = detailRow ? detailRow.children[0].textContent.trim() : '';
            rowsData.push({rowEl:r, detailEl: detailRow, dateText:date, dateObj: parseDateDMY(date), intitule, siret, montant, montantText, detail});
        });
    }

    // colorisation par tranche (tranche = 100). On utilise 3 classes
    // bucket = floor(abs(montant)/100)
    // logique: bucket 0-1 => band1, 2-9 => band2, >=10 => band3 (pour lisibilit√©)
    function applyColorBands(){
        rowsData.forEach(item => {
            item.rowEl.classList.remove('color-band-1','color-band-2','color-band-3');
            const absM = Math.abs(item.montant);
            const bucket = Math.floor(absM / 100);
            if(bucket <= 1) item.rowEl.classList.add('color-band-1');        // < 200$
            else if(bucket <= 9) item.rowEl.classList.add('color-band-2');   // 200 - 999$
            else item.rowEl.classList.add('color-band-3');                   // >= 1000$
        });
    }

    // mise √† jour des compteurs, totaux affich√©s
    function updateCountersAndTotals(visibleIndices){
        // total visible
        let total = 0;
        let totalNeg = 0;
        visibleIndices.forEach(i => {
            total += rowsData[i].montant;
            if(rowsData[i].montant < 0) totalNeg += rowsData[i].montant;
        });
        visibleTotalEl.textContent = (total >= 0 ? '+' : '') + total.toLocaleString() + '$';
        if(total < 0) {
            visibleTotalEl.classList.add('negatif');
        } else {
            visibleTotalEl.classList.remove('negatif');
        }

        if(totalNeg < 0){
            totalNegDisplay.textContent = `Total impay√©s (visible) : ${totalNeg.toLocaleString()} $`;
            totalNegDisplay.style.color = 'var(--danger)';
        } else {
            totalNegDisplay.textContent = '';
        }

        // total remises = nb de lignes (peut √™tre chang√© pour compter remises r√©elles)
        totalRemises.textContent = ` | ${filteredIndexList.length} remises trouv√©es`;
        resultCountEl.textContent = `${filteredIndexList.length} r√©sultat(s)`;
    }

    // rend visible une page (pagination)
    function renderPage(){
        const perPage = parseInt(perPageSelect.value,10);
        const total = filteredIndexList.length;
        const totalPages = Math.max(1, Math.ceil(total / perPage));
        if(currentPage > totalPages) currentPage = totalPages;
        const start = (currentPage - 1) * perPage;
        const slice = filteredIndexList.slice(start, start + perPage);

        // hide all rows first
        rowsData.forEach(item => {
            item.rowEl.style.display = 'none';
            if(item.detailEl) item.detailEl.style.display = 'none';
        });

        // show only slice
        rowsData.forEach((item,i) => {
            if(slice.includes(i)){
                item.rowEl.style.display = 'table-row';
            }
        });

        // update pagination UI
        const paginationEl = document.getElementById('pagination');
        paginationEl.innerHTML = '';
        for(let p = 1; p <= totalPages; p++){
            const btn = document.createElement('button');
            btn.textContent = p;
            btn.className = 'btn';
            if(p === currentPage) btn.classList.add('primary');
            btn.addEventListener('click', ()=>{ currentPage = p; renderPage(); });
            paginationEl.appendChild(btn);
        }

        updateCountersAndTotals(slice);
    }

    // filtrer selon la recherche (sur date, intitul√©, siret, montant, detail)
    function applyFilterAndRefresh(){
        const q = searchInput.value.trim().toLowerCase();
        filteredIndexList = [];
        rowsData.forEach((item, idx) => {
            const hay = (item.dateText + ' ' + item.intitule + ' ' + item.siret + ' ' + item.montantText + ' ' + item.detail).toLowerCase();
            if(hay.includes(q)) filteredIndexList.push(idx);
        });
        currentPage = 1;
        renderPage();
        // quand le filtre change, on met √† jour aussi le graphique secondaire (impay√©s)
        updateChartDatasets();
    }

    // tri des lignes (index col, type, ascending)
    function sortRows(indexCol, type, ascending){
        const compare = (a,b) => {
            if(type === 'number') return ascending ? a.montant - b.montant : b.montant - a.montant;
            if(type === 'date') return ascending ? a.dateObj - b.dateObj : b.dateObj - a.dateObj;
            // text (indexCol 1 => intitul√©, 2 => siret)
            const aa = (indexCol===1? a.intitule : a.siret).toLowerCase();
            const bb = (indexCol===1? b.intitule : b.siret).toLowerCase();
            return ascending ? aa.localeCompare(bb) : bb.localeCompare(aa);
        };

        // sort filteredIndexList by comparing underlying rowsData
        filteredIndexList.sort((i,j) => compare(rowsData[i], rowsData[j]));
        currentPage = 1;
        renderPage();
    }

    // toggle detail row
    function attachRowToggles(){
        rowsData.forEach(item => {
            const toggleCell = item.rowEl.querySelector('.row-toggle');
            if(toggleCell){
                toggleCell.style.cursor='pointer';
                toggleCell.addEventListener('click', (e)=>{
                    e.stopPropagation();
                    if(!item.detailEl) return;
                    const isHidden = item.detailEl.style.display === 'none' || item.detailEl.style.display === '';
                    item.detailEl.style.display = isHidden ? 'table-row' : 'none';
                    toggleCell.textContent = isHidden ? '‚ûñ' : '‚ûï';
                });
                // also allow clicking row to toggle (small hand behaviour)
                item.rowEl.addEventListener('click', (e)=>{
                    if(e.target === toggleCell) return; // already handled
                    if(!item.detailEl) return;
                    const isHidden = item.detailEl.style.display === 'none' || item.detailEl.style.display === '';
                    item.detailEl.style.display = isHidden ? 'table-row' : 'none';
                    toggleCell.textContent = isHidden ? '‚ûñ' : '‚ûï';
                });
            }
        });
    }

    // exports
    function exportCSV(){
        const headerCells = ['Date','Intitul√©','N¬∞ Siret','Montant','D√©tails'];
        const rows = [];
        const perPage = parseInt(perPageSelect.value,10);
        const start = (currentPage-1)*perPage;
        const slice = filteredIndexList.slice(start, start + perPage);
        slice.forEach(i => {
            const item = rowsData[i];
            rows.push([item.dateText, item.intitule, item.siret, item.montantText, item.detail]);
        });
        let csv = headerCells.join(';') + '\n';
        rows.forEach(r => {
            csv += r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(';') + '\n';
        });
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'REMISSES_EXPORT.csv';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
    }

    function exportXLS(){
        const perPage = parseInt(perPageSelect.value,10);
        const start = (currentPage-1)*perPage;
        const slice = filteredIndexList.slice(start, start + perPage);
        const wsData = [['DATE','INTITUL√â','N¬∞ SIRET','MONTANT','D√âTAILS']]; // titres en MAJUSCULES (US5 Epic5)
        slice.forEach(i => {
            const item = rowsData[i];
            wsData.push([item.dateText, item.intitule, item.siret, item.montant, item.detail]);
        });
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, 'REMISSES');
        XLSX.writeFile(wb, 'REMISSES_EXPORT.xlsx');
    }

    async function exportPDF(){
        // utilise jsPDF autotable et ajoute l'image du graphique si pr√©sent
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        // Titre en MAJUSCULE + √©ventuellement N¬∞ SIREN si unique
        const uniqueSirets = Array.from(new Set(filteredIndexList.map(i => rowsData[i].siret)));
        const sirenPart = uniqueSirets.length === 1 ? ` N¬∞ SIRET ${uniqueSirets[0]}` : '';
        const dateExtraction = new Date().toLocaleDateString('fr-FR');
        const title = `LISTE DES REMISES${sirenPart} - EXTRAIT DU ${dateExtraction}`.toUpperCase();
        doc.setFontSize(12);
        doc.text(title, 14, 12);

        // ajouter capture du chart (si pr√©sent)
        try {
            const imgData = chartInstance.toBase64Image(); // PNG
            // place image sous le titre
            const imgY = 16;
            const imgH = 50;
            doc.addImage(imgData, 'PNG', 14, imgY, 180, imgH);
            // table start after image
            var startY = imgY + imgH + 6;
        } catch(e){
            var startY = 20;
        }

        const perPage = parseInt(perPageSelect.value,10);
        const start = (currentPage-1)*perPage;
        const slice = filteredIndexList.slice(start, start + perPage);
        const body = slice.map(i => {
            const item = rowsData[i];
            return [item.dateText, item.intitule, item.siret, item.montantText, item.detail];
        });

        doc.autoTable({
            head: [['DATE','INTITUL√â','N¬∞ SIRET','MONTANT','D√âTAILS']],
            body,
            startY,
            styles: { fontSize: 9 }
        });

        doc.save('REMISSES_EXPORT.pdf');
    }

    // ---------- graphique Chart.js ----------
    const ctx = document.getElementById('graphique').getContext('2d');

    // helper: build labels from rowsData (unique sorted dates) or fallback to present labels
    function getSortedUniqueDates(){
        const dates = Array.from(new Set(rowsData.map(r => r.dateText)));
        dates.sort((a,b) => parseDateDMY(a) - parseDateDMY(b));
        return dates;
    }

    // compute datasets: chiffre d'affaire (somme positive) and impay√©s (somme n√©gative absolute) per date label
    function computeChartDatas(){
        const labels = getSortedUniqueDates();
        const caMap = {}; const impMap = {};
        labels.forEach(l => { caMap[l]=0; impMap[l]=0; });
        rowsData.forEach(r => {
            if(!(r.dateText in caMap)){
                caMap[r.dateText] = 0; impMap[r.dateText] = 0;
            }
            if(r.montant >= 0) caMap[r.dateText] += r.montant;
            else impMap[r.dateText] += Math.abs(r.montant);
        });
        const caArr = labels.map(l => caMap[l]);
        const impArr = labels.map(l => impMap[l]);
        return { labels, caArr, impArr };
    }

    // initial chart datasets
    let chartDataObj = computeChartDatas();
    const chartData = {
        labels: chartDataObj.labels.length ? chartDataObj.labels : ['--'],
        datasets: [
            {
                label: 'Chiffre d\'affaires',
                data: chartDataObj.caArr.length ? chartDataObj.caArr : [0],
                borderColor: 'green',
                backgroundColor: 'transparent',
                tension: 0.2,
                type: 'line',
                yAxisID: 'y'
            },
            {
                label: 'Impay√©s',
                data: chartDataObj.impArr.length ? chartDataObj.impArr : [0],
                borderColor: 'red',
                backgroundColor: 'rgba(255,0,0,0.1)',
                type: 'bar',
                yAxisID: 'y'
            }
        ]
    };

    let currentChartType = 'line'; // controls primary default; chart supports mixed types (line + bar)
    const chartInstance = new Chart(ctx, {
        type: currentChartType,
        data: chartData,
        options: {
            plugins: { legend: { display: true } },
            scales: {
                x: { title: { text: 'Date', display: true } },
                y: { title: { text: 'Montant ($)', display: true }, beginAtZero: true }
            }
        }
    });

    // when toggling simple chart type, keep datasets but change global type for dataset 0
    document.getElementById('chartTypeSelect').addEventListener('change', (e)=>{
        const t = e.target.value;
        // keep second dataset as bar (impay√©s) for clarity, set CA dataset to requested type
        chartInstance.config.data.datasets[0].type = t;
        chartInstance.update();
    });

    // helper to refresh chart datasets after filtering/sorting
    function updateChartDatasets(){
        // rebuild from filtered rows only (for chart showing filtered view)
        const labelsSet = new Set();
        filteredIndexList.forEach(i => labelsSet.add(rowsData[i].dateText));
        let labels = Array.from(labelsSet);
        labels.sort((a,b) => parseDateDMY(a) - parseDateDMY(b));
        if(labels.length === 0){
            // fallback to all dates if none filtered
            const all = computeChartDatas();
            chartInstance.data.labels = all.labels;
            chartInstance.data.datasets[0].data = all.caArr;
            chartInstance.data.datasets[1].data = all.impArr;
        } else {
            const caMap = {}; const impMap = {};
            labels.forEach(l => { caMap[l]=0; impMap[l]=0; });
            filteredIndexList.forEach(i => {
                const r = rowsData[i];
                if(r.montant >= 0) caMap[r.dateText] += r.montant;
                else impMap[r.dateText] += Math.abs(r.montant);
            });
            chartInstance.data.labels = labels;
            chartInstance.data.datasets[0].data = labels.map(l => caMap[l]);
            chartInstance.data.datasets[1].data = labels.map(l => impMap[l]);
        }
        chartInstance.update();
    }

    // ---------- initialisation et events ----------
    function wireTableHeaders(){
        headers.forEach((header, idx) => {
            header.addEventListener('click', ()=>{
                const type = header.dataset.type;
                const index = idx; // 0=date,1=text,2=text,3=number
                const arrow = header.querySelector('.arrow');
                const ascending = arrow.textContent === '‚Üì'; // toggling behavior
                // toggle arrows (reset others)
                headers.forEach(h => { const a = h.querySelector('.arrow'); if(a) a.textContent = '‚Üì'; });
                arrow.textContent = ascending ? '‚Üë' : '‚Üì';
                sortRows(index, type, ascending);
            });
        });
    }

    document.getElementById('perPage').addEventListener('change', ()=>{
        currentPage = 1;
        renderPage();
    });
    document.getElementById('prevPage').addEventListener('click', ()=>{
        if(currentPage>1){ currentPage--; renderPage(); }
    });
    document.getElementById('nextPage').addEventListener('click', ()=>{
        const perPage = parseInt(perPageSelect.value,10);
        const totalPages = Math.max(1, Math.ceil(filteredIndexList.length / perPage));
        if(currentPage < totalPages){ currentPage++; renderPage(); }
    });

    searchInput.addEventListener('input', ()=>{ applyFilterAndRefresh(); });

    document.getElementById('export-csv').addEventListener('click', exportCSV);
    document.getElementById('export-xls').addEventListener('click', exportXLS);
    document.getElementById('export-pdf').addEventListener('click', exportPDF);

    // wrapper pour initialiser l'UI
    function boot(){
        initRows();
        applyColorBands();
        attachRowToggles();
        wireTableHeaders();

        // initial filtered list = tout
        filteredIndexList = rowsData.map((_, idx) => idx);
        currentPage = 1;
        renderPage();

        // calcule solde global (d√©monstration : sommation de tous)
        const solde = rowsData.reduce((acc, r) => acc + r.montant, 0);
        const soldeEl = document.getElementById('solde-global');
        soldeEl.textContent = (solde >= 0 ? '+' : '') + solde.toLocaleString() + '$';
        if(solde < 0) soldeEl.classList.add('negatif');

        // accessibility/UX small improvement: show initial counts
        totalRemises.textContent = ` | ${rowsData.length} remises totales`;

        // initialise le graphique avec les donn√©es calcul√©es
        const initial = computeChartDatas();
        chartInstance.data.labels = initial.labels;
        chartInstance.data.datasets[0].data = initial.caArr; // CA
        chartInstance.data.datasets[1].data = initial.impArr; // impay√©s
        chartInstance.update();
    }

    // run boot
    boot();
</script>

</body>
</html>
